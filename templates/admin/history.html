{% extends "admin/base.html" %}

{% block title %}Scan History{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 2rem;">
    <form method="GET" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Search Filename</label>
            <input type="text" name="search" value="{{ search }}" placeholder="e.g. IMG_2023..." style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem;">
        </div>
        
        <div style="width: 150px;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Filter Result</label>
            <select name="result" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem;">
                <option value="">All</option>
                <option value="REAL" {% if result_filter == 'REAL' %}selected{% endif %}>REAL</option>
                <option value="FAKE" {% if result_filter == 'FAKE' %}selected{% endif %}>FAKE</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter"></i> Filter
        </button>
        
        <a href="{{ url_for('admin.history') }}" class="btn btn-outline">Reset</a>
        
        <div style="flex: 1;"></div>
        
        <div class="dropdown" style="position: relative;">
            <button class="btn btn-primary" type="button" onclick="var m=document.getElementById('export-menu'); m.style.display = (m.style.display === 'block' ? 'none' : 'block'); event.stopPropagation();">
                <i class="fas fa-download"></i> Export
            </button>
            <div id="export-menu" style="display: none; position: absolute; right: 0; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 0.25rem; z-index: 100; min-width: 120px;">
                <a href="{{ url_for('admin.export_history', format_type='csv') }}" style="display: block; padding: 0.5rem 1rem; text-decoration: none; color: #333; border-bottom: 1px solid #eee;">CSV</a>
                <a href="{{ url_for('admin.export_history', format_type='json') }}" style="display: block; padding: 0.5rem 1rem; text-decoration: none; color: #333;">JSON</a>
            </div>
        </div>
    </form>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Preview</th>
                <th>Result</th>
                <th>Confidence</th>
                <th>Filename</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for scan in history %}
            <tr>
                <td style="white-space: nowrap;">{{ scan.timestamp }}</td>
                <td>
                    <img src="{{ url_for('uploaded_file', filename=scan.filename) }}" alt="thumb" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                </td>
                <td>
                    <span class="badge {% if scan.result == 'REAL' %}badge-real{% else %}badge-fake{% endif %}">
                        {{ scan.result }}
                    </span>
                </td>
                <td>
                    <div style="width: 100px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                        <div style="width: {{ scan.confidence }}%; height: 100%; background: {% if scan.result == 'REAL' %}var(--success){% else %}var(--danger){% endif %};"></div>
                    </div>
                    <small>{{ "%.1f"|format(scan.confidence) }}%</small>
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ scan.filename }}
                </td>
                <td style="display: flex; gap: 0.5rem; align-items: center;">
                    <!-- Verification Actions -->
                    <form action="{{ url_for('admin.verify_scan') }}" method="POST" style="display: inline;">
                        <input type="hidden" name="timestamp" value="{{ scan.timestamp }}">
                        {% if scan.result == 'REAL' %}
                            <input type="hidden" name="status" value="FAKE">
                            <button type="submit" style="background: none; border: none; color: #ef4444; cursor: pointer;" title="Mark as FAKE">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        {% else %}
                            <input type="hidden" name="status" value="REAL">
                            <button type="submit" style="background: none; border: none; color: #10b981; cursor: pointer;" title="Mark as REAL">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        {% endif %}
                    </form>

                    <form action="{{ url_for('admin.delete_scan') }}" method="POST" onsubmit="return confirm('Delete this record?');" style="display: inline;">
                        <input type="hidden" name="timestamp" value="{{ scan.timestamp }}">
                        <button type="submit" style="background: none; border: none; color: #94a3b8; cursor: pointer;" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: #94a3b8;">
                    No records found matching your criteria.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Simple Pagination -->
    <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <span style="color: #64748b; font-size: 0.9rem;">Page {{ page }} of {{ total_pages }}</span>
        <div>
            {% if page > 1 %}
            <a href="{{ url_for('admin.history', page=page-1, search=search, result=result_filter) }}" class="btn btn-outline">Previous</a>
            {% endif %}
            
            {% if page < total_pages %}
            <a href="{{ url_for('admin.history', page=page+1, search=search, result=result_filter) }}" class="btn btn-outline">Next</a>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Close dropdown when clicking outside
    window.onclick = function(event) {
        var menu = document.getElementById('export-menu');
        if (menu && menu.style.display === 'block') {
             // If click is NOT inside the menu and NOT on the button (handled by stopPropagation)
             // actually, since we use stopPropagation on the button, we can just close it on any window click
             // IF the click target is not the menu itself.
             if (!menu.contains(event.target)) {
                 menu.style.display = 'none';
             }
        }
    }
</script>
{% endblock %}
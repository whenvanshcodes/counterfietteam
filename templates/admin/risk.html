{% extends "admin/base.html" %}

{% block title %}Scan Risk Heatmap{% endblock %}

{% block content %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    Showing high-risk scans: <strong>Low Confidence (< 85%)</strong> or <strong>Confirmed FAKE</strong>.
</div>

<div class="card">
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
        {% for scan in scans %}
        <div style="border: 1px solid {% if scan.result == 'FAKE' %}#fca5a5{% else %}#fcd34d{% endif %}; border-radius: 0.5rem; overflow: hidden;">
            <div style="position: relative;">
                <img src="{{ url_for('uploaded_file', filename=scan.filename) }}" style="width: 100%; height: 150px; object-fit: cover;">
                <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem;">
                    {{ scan.timestamp }}
                </div>
            </div>
            
            <div style="padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span class="badge {% if scan.result == 'FAKE' %}badge-fake{% else %}badge-real{% endif %}">{{ scan.result }}</span>
                    <span style="font-weight: bold; {% if scan.confidence < 85 %}color: #dc2626;{% endif %}">{{ "%.1f"|format(scan.confidence) }}%</span>
                </div>
                
                <p style="font-size: 0.8rem; color: #64748b; margin: 0;">
                    {% if scan.result == 'FAKE' %}
                        <i class="fas fa-times-circle" style="color: #ef4444;"></i> Confirmed Counterfeit
                    {% elif scan.confidence < 85 %}
                        <i class="fas fa-exclamation-circle" style="color: #eab308;"></i> Low Confidence Warning
                    {% endif %}
                </p>
                
                <div style="margin-top: 1rem; border-top: 1px solid #e2e8f0; padding-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                     <a href="{{ url_for('uploaded_file', filename=scan.filename) }}" target="_blank" style="color: var(--admin-accent); text-decoration: none; font-size: 0.9rem;">
                         <i class="fas fa-search-plus"></i> Inspect
                     </a>
                     
                     <!-- Verification Actions -->
                     <form action="{{ url_for('admin.verify_scan') }}" method="POST" style="display: inline;">
                         <input type="hidden" name="timestamp" value="{{ scan.timestamp }}">
                         {% if scan.result == 'REAL' %}
                             <button type="submit" name="status" value="REAL" class="btn-sm" style="background: #ecfdf5; border: 1px solid #10b981; color: #047857; cursor: pointer; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;" title="Confirm as REAL (Remove from Risk)">
                                 <i class="fas fa-check-double"></i> Confirm
                             </button>
                             <button type="submit" name="status" value="FAKE" class="btn-sm" style="background: #fef2f2; border: 1px solid #ef4444; color: #b91c1c; cursor: pointer; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem;" title="Mark as FAKE">
                                 <i class="fas fa-times"></i> Mark Fake
                             </button>
                         {% else %}
                             <button type="submit" name="status" value="REAL" class="btn-sm" style="background: #ecfdf5; border: 1px solid #10b981; color: #047857; cursor: pointer; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem;" title="Mark as REAL">
                                 <i class="fas fa-check"></i> Mark Real
                             </button>
                         {% endif %}
                     </form>
                </div>
            </div>
        </div>
        {% else %}
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94a3b8;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
            <p>No high-risk scans detected in the current history.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}